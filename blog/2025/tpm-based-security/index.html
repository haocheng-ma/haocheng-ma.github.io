<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="IZHz75ntcIC4eGlb8HT7ZmeXprRk-iWg8hQMbMEmd84"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Key management in TPM based security | Haocheng Ma </title> <meta name="author" content="Haocheng Ma"> <meta name="description" content="TPMs are ridiculously complex."> <meta name="keywords" content="haocheng ma, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,400;0,700;1,400;1,700&amp;family=Mulish:ital,wght@0,200..1000;1,200..1000&amp;family=Nunito:ital,wght@0,200..1000;1,200..1000&amp;family=Open+Sans:ital,wght@0,300..800;1,300..800&amp;family=Roboto:ital,wght@0,100..900;1,100..900&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="/assets/img/icon_pic.ico?201b24740f59dd40b09d1d7ec803eeaa"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://mahaocheng.me/blog/2025/tpm-based-security/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Haocheng</span> Ma </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Key management in TPM based security</h1> <p class="post-meta"> Created in July 24, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/tpm"> <i class="fa-solid fa-hashtag fa-sm"></i> tpm</a>   <a href="/blog/tag/measurement"> <i class="fa-solid fa-hashtag fa-sm"></i> measurement</a>   <a href="/blog/tag/attestation"> <i class="fa-solid fa-hashtag fa-sm"></i> attestation</a>   ·   <a href="/blog/category/cc"> <i class="fa-solid fa-tag fa-sm"></i> cc</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>TPM（可信平台模块）本质上并不会直接存储完整的密钥，而是持久化存储称为 Seed（种子）的秘密值，并通过这些 Seed 确定性地派生出各种密钥。两类常见的 Seed 和对应的密钥体系是 Endorsement 和 Stroage，如下所示：</p> <table> <thead> <tr> <th>Seed 类型</th> <th>密钥体系</th> <th>用途简述</th> </tr> </thead> <tbody> <tr> <td>Endorsement Seed</td> <td>Endorsement Key（EK）</td> <td>识别 TPM 的密钥</td> </tr> <tr> <td>Storage Seed</td> <td>Storage Root Key（SRK）</td> <td>本地应用使用的密钥</td> </tr> </tbody> </table> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2025-07-24-tpm-based-security/key_management.png" sizes="95vw"></source> <img src="/assets/img/2025-07-24-tpm-based-security/key_management.png" class="img-fluid rounded z-depth-0 mx-auto d-block" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <div class="caption">     Figure 1. Endorcement and Storage types in TPM Key Management </div> <p>上述密钥按照用途分为两类：Restricted 和 Non-Restricted。</p> <ul> <li>Restricted：用于签名或者解密 TPM 的状态和数据，例如，签名启动度量值、证明某个密钥位于同一个 TPM，EK、SRK、AIK 都在此类；</li> <li>Non-Restricted：用于一般用途，例如，TLS 客户端的密钥、签名普通文档的密钥，应用密钥（Application Key）属于此类。</li> </ul> <h2 id="endorsement-key">Endorsement Key</h2> <p>Endorsement Key（EK）是 TPM 的身份标识，由 TPM 制造商配置。</p> <ul> <li>EK 公私钥对由已知模板（EK Template）、Endorsement Primary Seed（EPS）和选定的密钥派生函数（KDF）、通过 <code class="language-plaintext highlighter-rouge">TPM2_CreatePrimary()</code> 确定性生成；</li> <li>EK 证书由TPM制造商的证书颁发机构（CA）签发并将其存储到 TPM NVRAM；</li> <li>EK 证书包含EK公钥以及其他字段，例如，TPM 制造商名称、组件型号、组件版本、密钥 ID 等。</li> </ul> <p>EK Template 的具体格式可查阅：<a href="https://trustedcomputinggroup.org/wp-content/uploads/TCG_IWG_EKCredentialProfile_v2p3_r2_pub.pdf#page=37" rel="external nofollow noopener" target="_blank">Default EK Template (TPMT_PUBLIC): RSA 2048 (Storage)</a></p> <p>EK 被存储在 TPM Shielded Location，私钥永远不能暴露，公钥可从 TPM 内读取。</p> <p>关于 TPM 的安全存储有两个概念：</p> <ul> <li>Isolated Locations：安全系统的非易失性存储，具有访问控制能力，不允许来自系统边界外的访问；</li> <li>Shielded Locations：具有防篡改能力的 Shielded Location，通常用于存储秘密值；</li> </ul> <h2 id="storage-root-key">Storage Root Key</h2> <p>在 TPM 的 Storage 体系结构中，密钥的创建遵循树状层级结构：</p> <ul> <li>比如 Attestation Key（AK）或应用密钥，都是在 TPM 的存储体系下生成的；</li> <li>这些密钥的父密钥是 SRK（Storage Root Key），SRK 是 TPM 中的一个根密钥，用于保护和派生其他密钥；</li> <li>而这些密钥的 key attestation（密钥认证） 则由 EK（Endorsement Key） 来实现。</li> </ul> <p>换句话说，Key attestation 是一种通过签名链建立信任的过程，核心目的是构建一条从 EK 一直到某个具体密钥（如 AK）的信任链。</p> <h2 id="attestation-key">Attestation Key</h2> <p>Attestation Key（AK）是一种用于对 TPM 内部数据进行签名的密钥，具有以下关键特性：</p> <ul> <li>non-duplicable（不可复制）：AK 是由 TPM 内部直接生成的，并且密钥材料不会暴露给 TPM 外部，这确保了其私钥无法被导出或复制，增强了安全性。</li> <li>Restricted（受限用途）：AK 只能用于对 TPM 生成的数据进行签名或解密，例如 PCR（平台配置寄存器）值。它不能用于任意数据的签名或加密，以防止其被滥用为通用密钥。</li> <li>签名密钥，用于设备身份（DevID）：AK 的公钥证书可以作为设备的身份凭据，由制造商或受信任方签发。</li> </ul> <p><em>“The 802.1AR standard defines a secure device identifier (DevID) as “an identifier that is cryptographically bound to a device”.”</em></p> <p>设备制造商在制造阶段创建的设备身份称为 IDevID/IAK，IDevID “Credential” 在设备整个生命周期内使用。用户在部署/应用阶段创建的设备身份称为 LDevID/LAK，LDevID “Credential” 会在设备复位或寿命结束时被移除。</p> <p><em>“Credential is a combination of a private key and a certificate.”</em></p> <p>Attestation Identity Key（AIK）是 TPM 1.2 中的一种密钥类型，AIK 仅被允许执行两种基于签名的操作：</p> <ul> <li>TPM_Quote：使用 AIK 对 PCR 寄存器值进行签名，生成代表设备身份和当前状态的硬件报告，常用于远程证明场景，也就是向远端证明设备当前的可信状态。</li> <li>TPM_CertifyKey：生成一个签名声明，用以证明另一个密钥（不是 AIK 本身）位于 TPM 的密钥存储体系中，且不可迁移（non-migratable）。显然，所认证的那个密钥必须实际具备这些属性。</li> </ul> <h2 id="credential-activation">Credential Activation</h2> <p>Credential activation 能够远程地建立对新密钥（例如，IAK）的信任，该密钥随后可以代表设备进行加密或证明，需要证明如下两点：</p> <ul> <li> <p>IAK（Identity Attestation Key）具备预期的密钥属性，例如：</p> <div class="language-c highlighter-rouge"> <div class="highlight"><pre class="highlight"><code> <span class="n">FlagFixedTPM</span>             <span class="c1">// 密钥不能被导出，必须留在 TPM 中；</span>
 <span class="n">FlagSensitiveDataOrigin</span>  <span class="c1">// 密钥必须由 TPM 内部生成，而不是导入；</span>
</code></pre></div> </div> </li> <li> <p>IAK 确实与 EK 存在于相同的 TPM 中。</p> </li> </ul> <p><em>Credential activation allows a remote party to verify one key is on the same TPM as another key, and that the key has a specific set of properties.</em></p> <p>大概的流程如下：Activation key 代指 IAK，Anchor key 代指 EK。</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2025-07-24-tpm-based-security/credential_activation.png" sizes="95vw"></source> <img src="/assets/img/2025-07-24-tpm-based-security/credential_activation.png" class="img-fluid rounded z-depth-0 mx-auto d-block" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <div class="caption">     Figure 2. The Flow of Credential Activation </div> <ul> <li>Client 将 IAK 的公钥、EK 的公钥和 IAK 的密钥属性发送给 Server；</li> <li> <p>Server 验证 IAK 的属性是否满足安全策略、生成秘密值并构造 Challenge，形式如下，然后返回给 Client：</p> <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>   Challenge = ENC{secret} | aes_key1
               ENC{key1}  | aes_key2
               ENC{seed}  | EK_pub
</code></pre></div> </div> <p>其中，<code class="language-plaintext highlighter-rouge">aes_key1</code> 是随机生成的对称密钥；<code class="language-plaintext highlighter-rouge">aes_key2 = KDF(seed, IAK name)</code>：KDF 是密钥派生函数，IAK name 是 IAK 公钥 Blob（包含属性）的哈希；所有敏感数据都用 EK 公钥加密，确保只能由目标 TPM 解密。</p> </li> <li>Client 将 Challenge 发送给 TPM，调用 <code class="language-plaintext highlighter-rouge">ActivateCredential</code> 命令；</li> <li>TPM 内部只有在拥有与 Challenge 匹配的 EK 和 IAK 的前提下，才能正确解密并返回秘密值。成功解密即意味着：IAK 存在于该 TPM 中；IAK 拥有正确的密钥属性。</li> </ul> <h2 id="reference">Reference</h2> <ol> <li><a href="">https://ericchiang.github.io/post/tpm-keys/</a></li> <li><a href="">https://tpm2-software.github.io/tpm2-tss/getting-started/2019/12/18/Remote-Attestation.html</a></li> <li><a href="">https://github.com/google/go-attestation/blob/master/docs/credential-activation.md</a></li> <li><a href="">https://github.com/tpm2dev/tpm.dev.tutorials</a></li> </ol> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/attest-grub-boot/">Remote attestation for confidential VMs using grub boot</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/tdx-measure-boot/">Measured boot in Intel TDX's grub boot</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Haocheng Ma. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"about",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"blog",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"nav-publications",title:"publications",description:"publications by categories in reversed chronological order.",section:"Navigation",handler:()=>{window.location.href="/publications/"}},{id:"post-key-management-in-tpm-based-security",title:"Key management in TPM based security",description:"TPMs are ridiculously complex.",section:"Posts",handler:()=>{window.location.href="/blog/2025/tpm-based-security/"}},{id:"post-remote-attestation-for-confidential-vms-using-grub-boot",title:"Remote attestation for confidential VMs using grub boot",description:"Our solution to establish trust for confidential VMs booting via firmware.",section:"Posts",handler:()=>{window.location.href="/blog/2025/attest-grub-boot/"}},{id:"post-measured-boot-in-intel-tdx-39-s-grub-boot",title:"Measured boot in Intel TDX&#39;s grub boot",description:"How to build a trusted chain when launch TD guest using grub boot.",section:"Posts",handler:()=>{window.location.href="/blog/2025/tdx-measure-boot/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%61%6E%64%72%65%77%6D%61%68%63@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-orcid",title:"ORCID",section:"Socials",handler:()=>{window.open("https://orcid.org/0000-0002-7118-9379","_blank")}},{id:"socials-google-scholar",title:"Google Scholar",section:"Socials",handler:()=>{window.open("https://scholar.google.com/citations?user=cdWqgwUAAAAJ","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/haocheng-ma","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>